{% extends "layouts/base.html" %}
{% block title %}ğŸ“Š Dashboard | Poker Manager{% endblock %}

{% block content %}
<section class="dashboard" aria-labelledby="dashboard-title">

  {% if current_user.is_authenticated %}
    <div class="container-xl py-4">
      {% include 'components/messages.html' %}
      <h1 id="dashboard-title" class="text-center mb-4">ğŸ“Š Dashboard di {{ current_user.nickname }}</h1>
      
      {% if db_error %}
        <div class="alert alert-warning d-flex align-items-center gap-2" role="alert">
          <i class="bi bi-exclamation-triangle-fill" role="img" aria-label="Attenzione"></i>
          <div>{{ error_msg }}</div>
        </div>
      {% endif %}

      <div class="card shadow-sm mb-4">
        <div class="card-header bg-body-tertiary d-flex justify-content-between align-items-center">
          <h2 class="h5 mb-0">ğŸ“ˆ Le tue Statistiche</h2>
        </div>
        <div class="card-body">
          {% if user_stats %}
          <div class="row g-3 text-center">
            <div class="col-md-4">
              <div class="card h-100">
                <div class="card-body">
                  <h6 class="card-subtitle mb-2 text-muted">La tua Classifica</h6>
                  <p class="display-4 fw-bold mb-0">#{{ user_rank }}</p>
                  <small class="text-muted">In base al profitto netto</small>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card h-100">
                <div class="card-body">
                  <h6 class="card-subtitle mb-2 text-muted">Profitto Netto</h6>
                  <p class="display-4 fw-bold mb-0 {{ 'text-success' if (user_stats.net_profit or 0) > 0 else ('text-danger' if (user_stats.net_profit or 0) < 0 else '') }}">
                    {{ "%.2f"|format(user_stats.net_profit or 0) }} â‚¬
                  </p>
                  <small class="text-muted">Vincite - Spese</small>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card h-100">
                <div class="card-body">
                  <h6 class="card-subtitle mb-2 text-muted">Tornei Giocati</h6>
                  <p class="display-4 fw-bold mb-0">{{ user_stats.num_tournaments or 0 }}</p>
                  <small class="text-muted">Totale partecipazioni</small>
                </div>
              </div>
            </div>
          </div>
          {% else %}
            <div class="alert alert-info">â„¹ï¸ Non hai ancora giocato nessun torneo.</div>
          {% endif %}
        </div>
      </div>
      
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-body-tertiary d-flex justify-content-between align-items-center">
          <h2 class="h5 mb-0">â±ï¸ I tuoi Ultimi 5 Tornei</h2>
        </div>
        <div class="card-body">
          {% if personal_tournaments %}
            <div class="table-responsive">
              <table class="table table-striped table-hover align-middle w-100">
                <thead class="table-dark">
                  <tr>
                    <th scope="col">Data</th>
                    <th scope="col">Torneo</th>
                    <th scope="col">Posizione</th>
                    <th scope="col">Profitto</th>
                    <th scope="col" class="text-center">Dettagli</th>
                  </tr>
                </thead>
                <tbody>
                  {% for tp in personal_tournaments %}
                  <tr>
                    <td>{{ tp.tournament.tournament_date.strftime('%d/%m/%Y') }}</td>
                    <td>{{ tp.tournament.name }}</td>
                    <td>{{ tp.posizione or '-' }}</td>
                    <td class="{{ 'text-success' if (tp.tournament_profit or 0) > 0 
                                else 'text-danger' if (tp.tournament_profit or 0) < 0 
                                else 'text-secondary' }}">
                      {{ '+' if (tp.tournament_profit or 0) > 0 else '' }}{{ "%.2f"|format(tp.tournament_profit or 0) }} â‚¬
                    </td>
                    <td class="text-center">
                      <a href="{{ url_for('tournaments.detail', tournament_id=tp.tournament.id) }}"
                         class="btn btn-sm btn-outline-primary d-inline-flex align-items-center gap-1"
                         aria-label="Vedi dettagli torneo {{ tp.tournament.name }}">
                        <i class="bi bi-eye-fill"></i>
                      </a>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="alert alert-info m-0">â„¹ï¸ Nessun torneo partecipato di recente.</div>
          {% endif %}
        </div>
      </div>
  
      <div class="card shadow-sm mb-4"> 
        <div class="card-header bg-body-tertiary d-flex justify-content-between align-items-center">
          <h2 class="h5 mb-0">ğŸ† Top 5 Performers (Globale)</h2>
        </div>
{% set real_players = players | selectattr("player.id", "ne", current_user.id) | list %}
        <div class="card-body">
          {% if real_players|length > 0 %}
            <div class="row g-4">
              {% for data in players %}
              <div class="col-12 col-md-6 col-lg-4">
                <div class="card h-100">
                  <div class="card-body d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                      <div>
                        <h5 class="card-title mb-1">{{ data.player.nickname }}</h5>
                        <p class="mb-0 {% if data.player.net_profit < 0 %}text-danger{% elif data.player.net_profit > 0 %}text-success{% else %}text-muted{% endif %} fw-bold">
                          {{ '%.2f'|format(data.player.net_profit) }} â‚¬
                        </p>
                        <p class="small text-muted mb-0">ğŸ² {{ data.player.num_tournaments }} Tornei</p>
                      </div>
                      <div class="ms-2 text-end">
                        <a href="{{ url_for('players.detail', player_id=data.player.id) }}"
                           class="btn btn-sm btn-outline-primary d-inline-flex align-items-center gap-1"
                           aria-label="Dettagli di {{ data.player.nickname }}">
                           <i class="bi bi-eye-fill" role="img" aria-hidden="true"></i>
                           Dettagli
                        </a>
                      </div>
                    </div>
                    <div class="chart-holder mt-auto">
                      <canvas id="chart-player-{{ data.player.id }}" 
                              data-player-id="{{ data.player.id }}"
                              class="chart-canvas" 
                              style="height: 180px;" aria-hidden="true"></canvas>
                    </div>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="alert alert-info">â„¹ï¸ Nessun giocatore registrato.</div>
          {% endif %}
        </div>
      </div>
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-body-tertiary d-flex justify-content-between align-items-center">
          <h2 class="h5 mb-0">ğŸ† Top 5 Tornei (Globale)</h2>
        </div>
        <div class="card-body">
          {% if tournaments and tournaments|length > 0 %}
            <div class="row g-4">
              {% for tournament in tournaments[:5] %}
              <div class="col-12 col-md-6 col-lg-4">
                <div class="card h-100 shadow-sm border-0">
                  <div class="card-body d-flex flex-column">
                    <h5 class="card-title mb-2">{{ tournament.name }}</h5>
                    <p class="small text-muted mb-2">
                      ğŸ“… {{ tournament.tournament_date.strftime('%d/%m/%Y') }}
                    </p>
                    <ul class="list-unstyled mb-3">
                      <li class="mb-1">ğŸ’µ <strong>{{ '%.2f'|format(tournament.buy_in) }} â‚¬</strong> Buy-in</li>
                      <li class="mb-1">ğŸ‘¥ <strong>{{ tournament.num_players }}</strong> Giocatori</li>
                      <li class="mb-1 text-success fw-bold">
                        ğŸ† Montepremi: <strong>{{ '%.2f'|format(tournament.total_prize_pool) }} â‚¬</strong>
                      </li>
                    </ul>
                    <div class="mt-auto">
                      <a href="{{ url_for('tournaments.detail', tournament_id=tournament.id) }}"
                         class="btn btn-outline-primary w-100 d-flex align-items-center justify-content-center gap-2"
                         aria-label="Dettagli torneo {{ tournament.name }}">
                         <i class="bi bi-eye-fill" role="img" aria-hidden="true"></i>
                         Dettagli
                      </a>
                    </div>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="alert alert-info">â„¹ï¸ Nessun torneo disponibile per ora.</div>
          {% endif %}
        </div>
      </div>

    </div> 
  {% else %}
    <div class="p-5 mb-4 bg-body-tertiary rounded-3 text-center"> 
      <div class="container-fluid py-5">
        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="currentColor"
             class="bi bi-suit-spade-fill text-primary mb-3" viewBox="0 0 16 16"
             role="img" aria-hidden="true">
        </svg>
        <h1 class="display-5 fw-bold" id="dashboard-title">Benvenuto su Poker Manager</h1>
        <p class="fs-4 text-muted col-md-8 mx-auto">
          La tua soluzione all-in-one per gestire tornei di poker, tracciare statistiche 
          avanzate e competere nella leaderboard.
        </p>
        <a href="{{ url_for('auth.login') }}" class="btn btn-primary btn-lg mt-3">
          Accedi per iniziare
        </a>
      </div>
    </div>
  {% endif %}
</section>
{% endblock %}


{% block scripts %}
  {{ super() }} {% if current_user.is_authenticated %}
    
    <script type="module" defer>
      // Importa le funzioni dal file charts.js
      import { buildChartDataMap, createMiniCharts } from "{{ url_for('static', filename='js/charts/charts.js') }}";
      
      // Passa i dati da Jinja (backend) a JavaScript (frontend)
      const playersData = {{ players | tojson }}; // Funziona solo se players in views.py Ã¨ serializzabile!

      function initDashboard() {
        // 1. Mappa i dati JSON in una struttura JS
        buildChartDataMap(playersData); 
        
        // 2. Disegna i grafici
        createMiniCharts();
      }
      
      // Inizializzazione standard
      document.addEventListener('DOMContentLoaded', initDashboard);

      // Esegui di nuovo se il tema cambia (evento da base.html)
      document.addEventListener('themeChanged', () => {
        setTimeout(createMiniCharts, 100); 
      });
    </script>
  {% endif %}
{% endblock %}