{% extends "layouts/base.html" %}

{% block title %}Dettagli Torneo: {{ tournament.name }} | Poker Manager{% endblock %}

{% block content %}
<div class="container--narrow py-4">

  <div class="mb-4">
    <a href="{{ url_for('tournaments.list') }}" class="btn btn-outline-secondary d-inline-flex align-items-center gap-1">
      <i class="bi bi-arrow-left"></i> Torna all'Elenco
    </a>
  </div>

  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2 fade-in">
    <h1 class="h3 mb-0 d-inline-flex align-items-center gap-2">
      <i class="bi bi-trophy-fill text-warning"></i> 
      {{ tournament.name }}
    </h1>
    
    {% if current_user.is_authenticated and current_user.is_admin %}
      <div class="d-flex gap-2">
        <a href="{{ url_for('tournaments.edit_tournament', tournament_id=tournament.id) }}"
           class="btn btn-outline-warning d-inline-flex align-items-center gap-1"
           aria-label="Modifica {{ tournament.name }}">
          <i class="bi bi-pencil-fill"></i> Modifica
        </a>
        <button type="button" 
                class="btn btn-outline-danger d-inline-flex align-items-center gap-1" 
                data-bs-toggle="modal" 
                data-bs-target="#deleteTournamentModal"
                data-tournament-id="{{ tournament.id }}"
                data-tournament-name="{{ tournament.name }}"
                aria-label="Elimina {{ tournament.name }}">
          <i class="bi bi-trash3-fill"></i> Elimina
        </button>
      </div>
    {% endif %}
  </div>

  <div class="card shadow-sm mb-4 fade-in" style="animation-delay: 0.1s;">
    <div class="card-header bg-dark text-white">
      <h2 class="h5 mb-0"><i class="bi bi-info-circle-fill me-2"></i> Informazioni Torneo</h2>
    </div>
    <div class="card-body">
      <div class="tournament-info-grid">
        <div><strong>üìÖ Data</strong> <span>{{ tournament.tournament_date.strftime('%d/%m/%Y') }}</span></div>
        <div><strong>üí∞ Buy-in</strong> <span>{{ '%.2f'|format(tournament.buy_in or 0) }} ‚Ç¨</span></div>
        <div><strong>üë• Giocatori</strong> <span>{{ tournament.num_players or 0 }}</span></div>
        <div><strong>üèÜ Montepremi</strong> <span class="fw-bold text-success">{{ '%.2f'|format(tournament.total_prize_pool or 0) }} ‚Ç¨</span></div>
        <div><strong>üîÑ Rebuy Totali</strong> <span>{{ tournament.num_rebuys or 0 }}</span></div>
        <div><strong>üí∂ Spesa Rebuy Tot.</strong> <span>{{ '%.2f'|format(tournament.total_rebuy_spent or 0) }} ‚Ç¨</span></div>
        {% if tournament.location %}
        <div class="grid-column-span-auto"><strong>üìç Luogo</strong> <span>{{ tournament.location }}</span></div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="card shadow-sm mb-4 fade-in" style="animation-delay: 0.2s;">
    <div class="card-header bg-dark text-white">
      <h2 class="h5 mb-0"><i class="bi bi-list-stars me-2"></i> Classifica Giocatori</h2>
    </div>
    <div class="card-body">
      {% if participants %}
        <div class="table-responsive">
          <table id="participantsTable" class="table table-striped table-hover align-middle w-100">
            <thead class="table-dark">
              <tr>
                <th scope="col" style="width: 5%;">üèÖ Pos.</th>
                <th scope="col">Nickname</th>
                <th scope="col" class="d-none d-md-table-cell">Nome</th> <th scope="col">üîÑ Rebuy</th>
                <th scope="col">üí≤ Vincita</th>
                <th scope="col" class="text-center">‚öôÔ∏è Azioni</th>
                <th scope="col" class="d-none">Posizione Ord.</th> 
              </tr>
            </thead>
            <tbody>
              {% for tp in participants %}
              <tr class="{% if tp.posizione == 1 %}table-warning{% elif tp.posizione == 2 %}table-secondary{% elif tp.posizione == 3 %}table-danger bg-opacity-25{% endif %}">
                <td class="fw-bold">
                  {% if tp.posizione %}{{ tp.posizione }}{% else %}-{% endif %}
                </td>
                <td>
                  <a href="{{ url_for('players.detail', player_id=tp.player.id) }}" class="fw-medium">
                    {{ tp.player.nickname }}
                  </a>
                </td>
                <td class="d-none d-md-table-cell">{{ tp.player.first_name or '' }} {{ tp.player.last_name or '' }}</td>
                <td>{{ tp.rebuy or 0 }}</td>
                <td class="{{ 'text-success fw-bold' if (tp.prize or 0) > 0 else '' }}">
                  {{ '%.2f'|format(tp.prize or 0) }} ‚Ç¨
                </td>
                <td class="text-center">
                   <a href="{{ url_for('players.detail', player_id=tp.player.id) }}"
                     class="btn btn-sm btn-outline-primary d-inline-flex align-items-center gap-1"
                     aria-label="Vedi dettagli giocatore {{ tp.player.nickname }}">
                    <i class="bi bi-person-fill"></i> <span class="d-none d-lg-inline">Profilo</span>
                  </a>
                </td>
                <td class="d-none">{{ tp.posizione if tp.posizione is not none else 99999 }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="text-muted text-center my-3">
          <i class="bi bi-info-circle me-2"></i> Nessun giocatore partecipante registrato per questo torneo.
           {% if current_user.is_authenticated and current_user.is_admin %}
             {% endif %}
        </p>
      {% endif %}
    </div>
  </div> {% if current_user.is_authenticated and current_user.is_admin %}
  <div class="modal fade" id="deleteTournamentModal" tabindex="-1" aria-labelledby="deleteTournamentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title" id="deleteTournamentModalLabel">
            <i class="bi bi-exclamation-triangle-fill me-2"></i> Conferma Eliminazione
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Chiudi"></button>
        </div>
        <div class="modal-body">
          Sei sicuro di voler eliminare il torneo <strong id="modalTournamentName">{{ tournament.name }}</strong>?
          <br>
          <small class="text-muted">Questa azione eliminer√† anche tutte le partecipazioni associate e non pu√≤ essere annullata.</small>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
          <form id="deleteTournamentForm" method="POST" action="{{ url_for('tournaments.delete_tournament', tournament_id=tournament.id) }}" class="delete-tournament-form d-inline">
             {{ delete_form.csrf_token }} <button type="submit" class="btn btn-danger">
               <i class="bi bi-trash3-fill"></i> Elimina Torneo
             </button>
          </form>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

</div> {% endblock %}


{% block scripts %}
{{ super() }} <script defer>
  $(document).ready(function () {
    // Inizializza DataTables per la tabella partecipanti
    $('#participantsTable').DataTable({
      language: { url: 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/it-IT.json' },
      pageLength: 10, 
      // Ordina per la colonna nascosta 'Posizione Ord.' (indice 6)
      order: [[6, 'asc']], 
      columnDefs: [
        { orderable: false, targets: [5] }, // Azioni non ordinabili
        { targets: [6], visible: false }, // Nasconde colonna ordinamento
        { responsivePriority: 1, targets: 0 }, // Posizione
        { responsivePriority: 2, targets: 1 }, // Nickname
        { responsivePriority: 3, targets: 5 }, // Azioni
        { responsivePriority: 4, targets: 4 }, // Vincita
        { responsivePriority: 5, targets: 3 }, // Rebuy
        { responsivePriority: 6, targets: 2 }  // Nome Completo
      ],
      responsive: true,
      "drawCallback": function( settings ) {
        const rows = $('#participantsTable tbody tr');
        rows.removeClass('fade-in'); 
        void rows[0]?.offsetWidth; 
        rows.addClass('fade-in'); 
      }
    });

    // --- Gestione Modal Eliminazione (semplificata per dettaglio) ---
    const deleteModal = document.getElementById('deleteTournamentModal');
    if (deleteModal) {
      const modalTournamentName = document.getElementById('modalTournamentName');
      deleteModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget; 
        if (button) {
            const tournamentName = button.getAttribute('data-tournament-name');
            if (tournamentName) {
                 modalTournamentName.textContent = tournamentName;
            }
        } 
      });
    }
  });
</script>
{% endblock %}